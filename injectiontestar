-- ✅ ESP Jogadores + Jump + ESP Base Funcional + Interface Melhorada
-- ✅ Testado para lógica de contagem de bases com dono
-- OBS: Ajuste o nome do botão de trancar se necessário

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESPAtivo, JumpAtivo, BasesESPAtivo = false, false, false
local JumpPowerDesejado = 100

local Drawings = {}
local BaseDrawings = {}
local Bases = {} -- base -> {tempo, dono, button}

-- ======================
-- Funções de Interface
-- ======================
local gui, frame

local function CriarInterface()
    gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
    gui.ResetOnSpawn = false
    gui.Name = "PainelHack"

    frame = Instance.new("Frame", gui)
    frame.Size = UDim2.new(0, 220, 0, 240)
    frame.Position = UDim2.new(0, 10, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 50)
    frame.BorderSizePixel = 0

    local titulo = Instance.new("TextLabel", frame)
    titulo.Size = UDim2.new(1, 0, 0, 30)
    titulo.BackgroundColor3 = Color3.fromRGB(0, 85, 255)
    titulo.Text = "Injection - Roblox FREE"
    titulo.TextColor3 = Color3.fromRGB(255, 255, 255)
    titulo.TextSize = 18
    titulo.Font = Enum.Font.SourceSansBold

    -- Botões minimizar e fechar
    local botaoMin = Instance.new("TextButton", frame)
    botaoMin.Size = UDim2.new(0, 30, 0, 30)
    botaoMin.Position = UDim2.new(1, -60, 0, 0)
    botaoMin.Text = "–"
    botaoMin.TextSize = 20
    botaoMin.BackgroundColor3 = Color3.fromRGB(0, 40, 100)
    botaoMin.TextColor3 = Color3.new(1,1,1)
    botaoMin.MouseButton1Click:Connect(function()
        frame.Visible = false
        if not gui:FindFirstChild("ReabrirBotao") then
            local reabrir = Instance.new("TextButton", gui)
            reabrir.Name = "ReabrirBotao"
            reabrir.Size = UDim2.new(0, 120, 0, 30)
            reabrir.Position = UDim2.new(0, 10, 0, 10)
            reabrir.BackgroundColor3 = Color3.fromRGB(0, 85, 255)
            reabrir.TextColor3 = Color3.new(1,1,1)
            reabrir.Text = "Abrir Painel"
            reabrir.TextSize = 16
            reabrir.MouseButton1Click:Connect(function()
                frame.Visible = true
                reabrir:Destroy()
            end)
        end
    end)

    local botaoFechar = Instance.new("TextButton", frame)
    botaoFechar.Size = UDim2.new(0, 30, 0, 30)
    botaoFechar.Position = UDim2.new(1, -30, 0, 0)
    botaoFechar.Text = "X"
    botaoFechar.TextSize = 20
    botaoFechar.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    botaoFechar.TextColor3 = Color3.new(1,1,1)
    botaoFechar.MouseButton1Click:Connect(function()
        gui:Destroy()
    end)

    local function CriarBotao(texto, posY, aoClicar)
        local botao = Instance.new("TextButton", frame)
        botao.Size = UDim2.new(1, -20, 0, 30)
        botao.Position = UDim2.new(0, 10, 0, posY)
        botao.BackgroundColor3 = Color3.fromRGB(0, 40, 100)
        botao.TextColor3 = Color3.new(1, 1, 1)
        botao.Font = Enum.Font.SourceSans
        botao.TextSize = 16
        botao.Text = texto
        botao.MouseButton1Click:Connect(function()
            aoClicar(botao)
        end)
        return botao
    end

    CriarBotao("ESP: OFF", 40, function(btn)
        ESPAtivo = not ESPAtivo
        btn.Text = ESPAtivo and "ESP: ON" or "ESP: OFF"
    end)

    CriarBotao("Jump: OFF", 80, function(btn)
        JumpAtivo = not JumpAtivo
        if not JumpAtivo and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = 50
        end
        btn.Text = JumpAtivo and "Jump: ON" or "Jump: OFF"
    end)

    CriarBotao("ESP Base: OFF", 120, function(btn)
        BasesESPAtivo = not BasesESPAtivo
        btn.Text = BasesESPAtivo and "ESP Base: ON" or "ESP Base: OFF"
    end)

    local sliderLabel = Instance.new("TextLabel", frame)
    sliderLabel.Size = UDim2.new(1, -20, 0, 20)
    sliderLabel.Position = UDim2.new(0, 10, 0, 160)
    sliderLabel.BackgroundTransparency = 1
    sliderLabel.TextColor3 = Color3.new(1, 1, 1)
    sliderLabel.Font = Enum.Font.SourceSans
    sliderLabel.TextSize = 16
    sliderLabel.Text = "Jump: " .. JumpPowerDesejado

    local caixa = Instance.new("TextBox", frame)
    caixa.Size = UDim2.new(1, -20, 0, 30)
    caixa.Position = UDim2.new(0, 10, 0, 185)
    caixa.BackgroundColor3 = Color3.fromRGB(0, 40, 100)
    caixa.TextColor3 = Color3.new(1, 1, 1)
    caixa.Font = Enum.Font.SourceSans
    caixa.TextSize = 16
    caixa.Text = tostring(JumpPowerDesejado)

    caixa.FocusLost:Connect(function(enter)
        if enter then
            local valor = tonumber(caixa.Text)
            if valor and valor > 0 then
                JumpPowerDesejado = valor
                sliderLabel.Text = "Jump: " .. JumpPowerDesejado
            else
                caixa.Text = tostring(JumpPowerDesejado)
            end
        end
    end)

    CriarBotao("🌐 Discord", 220, function()
        setclipboard("https://discord.gg/scriptroblox")
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Discord",
            Text = "Link copiado para área de transferência!",
            Duration = 3
        })
    end)
end

-- ======================
-- ESP Jogadores
-- ======================
local function CriarCaixa(plr)
    local box = Drawing.new("Square")
    box.Visible = false
    box.Thickness = 2
    box.Color = Color3.fromRGB(0, 255, 255)
    box.Filled = false
    Drawings[plr] = box
end

-- Inicializar jogadores
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then CriarCaixa(p) end
end

Players.PlayerAdded:Connect(function(p)
    if p ~= LocalPlayer then CriarCaixa(p) end
end)

-- ======================
-- ESP Base Funcional
-- ======================
local function DetectarBases()
    for _, obj in ipairs(workspace:GetChildren()) do
        if obj:IsA("Model") and obj.Name:match("Base_") then
            local dono = obj.Name:sub(6)
            if not Bases[obj] then
                local button = obj:FindFirstChild("Trancar") -- ajuste conforme o nome real
                Bases[obj] = {tempo = 0, dono = dono, button = button}
                
                local esp = Drawing.new("Text")
                esp.Color = Color3.fromRGB(255, 0, 0)
                esp.Text = "0s"
                esp.Size = 50
                esp.Center = true
                esp.Visible = true
                BaseDrawings[obj] = esp
            end
        end
    end
end

local function AtualizarBases(dt)
    for base, info in pairs(Bases) do
        -- Se botão do dono foi tocado, reinicia o tempo
        if info.button and info.button:IsA("BasePart") and info.button.Touched then
            local connections = info.button:GetTouchingParts()
            for _, part in ipairs(connections) do
                if part.Parent and part.Parent.Name == info.dono then
                    info.tempo = 0
                end
            end
        end
        info.tempo = info.tempo + dt

        -- Atualizar desenho
        if BaseDrawings[base] and base.PrimaryPart then
            local pos, onScreen = Camera:WorldToViewportPoint(base.PrimaryPart.Position)
            if onScreen then
                BaseDrawings[base].Position = Vector2.new(pos.X,pos.Y)
                BaseDrawings[base].Text = tostring(math.floor(info.tempo *)) .. "s"
                BaseDrawings[base].Visible = true
            else
                BaseDrawings[base].Visible = false
            end
        end
    end
end

-- ======================
-- Atualizações a cada frame
-- ======================
RunService.RenderStepped:Connect(function(dt)
    -- Jogadores ESP
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local box = Drawings[plr]
            if not box then CriarCaixa(plr); box = Drawings[plr] end
            local char = plr.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            local head = char and char:FindFirstChild("Head")
            if ESPAtivo and hrp and head then
                local top = Camera:WorldToViewportPoint(head.Position + Vector3.new(0,0.5,0))
                local bottom = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0,2.5,0))
                if bottom.Z > 0 then
                    local height = math.abs(top.Y - bottom.Y)
                    local width = height / 2
                    box.Size = Vector2.new(width,height)
                    box.Position = Vector2.new(top.X - width/2, top.Y)
                    box.Visible = true
                else box.Visible = false end
            else box.Visible = false end
        end
    end

    -- Jump
    if JumpAtivo and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
        LocalPlayer.Character.Humanoid.JumpPower = JumpPowerDesejado
        LocalPlayer.Character.Humanoid.UseJumpPower = true
    end

    -- Bases
    if BasesESPAtivo then
        DetectarBases()
        AtualizarBases(dt)
    else
        for _, info in pairs(BaseDrawings) do
            info.Visible = false
        end
    end
end)

-- Jump ao renascer
LocalPlayer.CharacterAdded:Connect(function(char)
    local hum = char:WaitForChild("Humanoid")
    if JumpAtivo then
        hum.JumpPower = JumpPowerDesejado
        hum.UseJumpPower = true
    end
end)

-- Inicializa interface
CriarInterface()

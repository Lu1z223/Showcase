local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local ESPAtivo, SpeedAtivo, JumpAtivo = false, false, false
local VelocidadeDesejada = 30 -- ✅ Velocidade segura (~30 studs/s)
local JumpPowerDesejado = 100
local Drawings = {}
local FrameMenu
local posicaoSalva = nil

-- Estado do Speed
local speedState = { speedConn = nil, diedConn = nil }

local function StopEnforceSpeed()
    if speedState.speedConn then pcall(function() speedState.speedConn:Disconnect() end) end
    if speedState.diedConn then pcall(function() speedState.diedConn:Disconnect() end) end
    speedState.speedConn, speedState.diedConn = nil, nil
end

-- Movimento Speed via Heartbeat (seguro e suave)
local function StartEnforceSpeed(humanoid)
    StopEnforceSpeed()
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    speedState.speedConn = RunService.Heartbeat:Connect(function(deltaTime)
        if SpeedAtivo and hrp and hrp.Parent and humanoid and humanoid.Parent then
            local moveDir = humanoid.MoveDirection
            if moveDir.Magnitude > 0 then
                local safeSpeed = VelocidadeDesejada * deltaTime -- ~30 studs/s
                hrp.CFrame = hrp.CFrame + (moveDir * safeSpeed)
            end
        end
    end)

    speedState.diedConn = humanoid.Died:Connect(function() StopEnforceSpeed() end)
end

-- Aplicar modificações de Speed e Jump
local function AplicarModificacoes(humanoid)
    if not humanoid then return end
    if SpeedAtivo then
        StartEnforceSpeed(humanoid)
    else
        StopEnforceSpeed()
    end
    if JumpAtivo then
        humanoid.JumpPower = JumpPowerDesejado
        humanoid.UseJumpPower = true
        task.spawn(function()
            while JumpAtivo and humanoid and humanoid.Parent do
                pcall(function()
                    humanoid.JumpPower = JumpPowerDesejado
                    humanoid.UseJumpPower = true
                end)
                task.wait(0.1)
            end
        end)
    else
        humanoid.JumpPower = 50
        humanoid.UseJumpPower = true
    end
end

LocalPlayer.CharacterAdded:Connect(function(character)
    local humanoid = character:WaitForChild("Humanoid")
    AplicarModificacoes(humanoid)
    if SpeedAtivo then StartEnforceSpeed(humanoid) end
end)

-- Voo rápido até posição salva (suave e seguro)
local function VoarParaPosicao(hrp, destino)
    local conexao
    conexao = RunService.Heartbeat:Connect(function(deltaTime)
        if not hrp or not hrp.Parent then 
            conexao:Disconnect()
            return 
        end

        local diff = destino - hrp.Position
        local dist = diff.Magnitude

        if dist < 1 then
            hrp.CFrame = CFrame.new(destino, destino + hrp.CFrame.LookVector)
            conexao:Disconnect()
        else
            local stepSize = math.min(dist, 10 * deltaTime) -- ~10 studs/s
            local step = diff.Unit * stepSize
            hrp.CFrame = hrp.CFrame + step
        end
    end)
end

-- Interface
local function CriarInterface()
    local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
    gui.ResetOnSpawn = false
    gui.Name = "Injection - Roblox"

    local botaoAbrir = Instance.new("TextButton", gui)
    botaoAbrir.Size = UDim2.new(0, 100, 0, 40)
    botaoAbrir.Position = UDim2.new(0, 10, 1, -50)
    botaoAbrir.BackgroundColor3 = Color3.fromRGB(0, 85, 255)
    botaoAbrir.Text = "Abrir Menu"
    botaoAbrir.TextColor3 = Color3.fromRGB(255, 255, 255)
    botaoAbrir.TextSize = 16
    botaoAbrir.Font = Enum.Font.SourceSansBold

    local frame = Instance.new("Frame", gui)
    frame.Size = UDim2.new(0, 200, 0, 240)
    frame.Position = UDim2.new(0, 10, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 50)
    frame.BorderSizePixel = 0
    frame.Visible = false
    FrameMenu = frame

    local titulo = Instance.new("TextLabel", frame)
    titulo.Size = UDim2.new(1, 0, 0, 30)
    titulo.BackgroundColor3 = Color3.fromRGB(0, 85, 255)
    titulo.Text = "Injection - Roblox"
    titulo.TextColor3 = Color3.fromRGB(255, 255, 255)
    titulo.TextSize = 18
    titulo.Font = Enum.Font.SourceSansBold

    local fechar = Instance.new("TextButton", frame)
    fechar.Size = UDim2.new(0, 30, 0, 30)
    fechar.Position = UDim2.new(1, -35, 0, 0)
    fechar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    fechar.Text = "X"
    fechar.TextColor3 = Color3.new(1, 1, 1)
    fechar.TextSize = 16
    fechar.Font = Enum.Font.SourceSansBold
    fechar.MouseButton1Click:Connect(function() frame.Visible = false end)

    local function CriarBotao(texto, posY, aoClicar)
        local botao = Instance.new("TextButton", frame)
        botao.Size = UDim2.new(1, -20, 0, 30)
        botao.Position = UDim2.new(0, 10, 0, posY)
        botao.BackgroundColor3 = Color3.fromRGB(0, 40, 100)
        botao.TextColor3 = Color3.new(1, 1, 1)
        botao.Font = Enum.Font.SourceSans
        botao.TextSize = 16
        botao.Text = texto
        botao.MouseButton1Click:Connect(function() aoClicar(botao) end)
    end

    CriarBotao("ESP: OFF", 40, function(btn)
        ESPAtivo = not ESPAtivo
        btn.Text = ESPAtivo and "ESP: ON" or "ESP: OFF"
    end)
    CriarBotao("Speed: OFF", 80, function(btn)
        SpeedAtivo = not SpeedAtivo
        btn.Text = SpeedAtivo and "Speed: ON" or "Speed: OFF"
        local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        AplicarModificacoes(humanoid)
    end)
    CriarBotao("Jump: OFF", 120, function(btn)
        JumpAtivo = not JumpAtivo
        btn.Text = JumpAtivo and "Jump: ON" or "Jump: OFF"
        local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        AplicarModificacoes(humanoid)
    end)
    CriarBotao("Salvar Posição", 160, function(btn)
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            posicaoSalva = char.HumanoidRootPart.Position
            btn.Text = "Posição Salva!"
            task.delay(1.5, function() btn.Text = "Salvar Posição" end)
        end
    end)
    CriarBotao("Voltar Posição", 200, function()
        if posicaoSalva then
            local char = LocalPlayer.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if hrp then
                VoarParaPosicao(hrp, posicaoSalva)
            end
        end
    end)

    botaoAbrir.MouseButton1Click:Connect(function() frame.Visible = not frame.Visible end)
end

-- ESP
local function CriarCaixa(plr)
    local box = Drawing.new("Square")
    box.Visible = false
    box.Thickness = 2
    box.Color = Color3.fromRGB(0, 255, 255)
    box.Filled = false
    Drawings[plr] = box
end

RunService.RenderStepped:Connect(function()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            if not Drawings[plr] then CriarCaixa(plr) end
            local box = Drawings[plr]
            local char = plr.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            local head = char and char:FindFirstChild("Head")
            if ESPAtivo and hrp and head and (not plr.Team or plr.Team ~= LocalPlayer.Team) then
                local top = workspace.CurrentCamera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                local bottom = workspace.CurrentCamera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 2.5, 0))
                if bottom.Z > 0 then
                    local height = math.abs(top.Y - bottom.Y)
                    local width = height / 2
                    box.Size = Vector2.new(width, height)
                    box.Position = Vector2.new(top.X - width / 2, top.Y)
                    box.Visible = true
                else
                    box.Visible = false
                end
            else
                box.Visible = false
            end
        end
    end
end)

-- Inicialização
CriarInterface()
if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
    AplicarModificacoes(LocalPlayer.Character:FindFirstChildOfClass("Humanoid"))
    if SpeedAtivo then StartEnforceSpeed(LocalPlayer.Character:FindFirstChildOfClass("Humanoid")) end
end
